# Detector Pipeline

### TL:DR 
### Итоговый пайплайн

1. **Вход**: Изображение  с штрих-кодами и QR-кодами.
2. **Детекция**: YOLO11x-OBB предсказывает четырёхугольники, классы и уверенность.
3. **Оценка**: Проверка CR (≥0.95), HD (≤10 пикселей), DSR (>90%).
4. **Обработка**: Обрезка по вершинам.
5. **Выход**: Обрезанные изображения подаются в декодер.

---
### Используемая модель

- **Модель**: **YOLO11x-OBB** .
- **Почему выбрана**:
    - Поддерживает oriented object detection с предсказанием произвольных четырёхугольников, что соответствует разметке данных.
    - Наиболее современная модель на данный момент (октябрь 2024)
    - Удобное обучение и настройка модели (работает практически из коробки)
    - Высокая точность (mAP@50 около 81.3% на DOTAv1) и современная архитектура
    - Гибкость для работы с несколькими типами кодов (QR, EAN13, DM) на одном изображении.
- **Предобучение**: Используются веса, предобученные на датасете DOTAv1, с последующей дообучкой на нашем датасете.


### Данные и формат подачи

- **Формат разметки**:
    - Аннотации представлены в виде json файлов содержащих произвольные четырёхугольники (quadrilaterals) с координатами четырёх вершин (x1, y1, x2, y2, x3, y3, x4, y4) и тегами классов (например, "ean13", "qr", "dm").
- **Подача в модель**:
    - Данные преобразуются в формат YOLO OBB: текстовые файлы с нормализованными координатами вершин и идентификатором класса (например, 0 0.286 0.132 0.271 0.127 0.293 0.120 0.305 0.125).
    - Файл data.yaml определяет пути к изображениям и классы
- **Обработка особых случаев**:
    - **Перекрытие штрих-кодов**: YOLO11x-OBB поддерживает детекцию нескольких объектов в одном изображении, включая перекрывающиеся. Non-Maximum Suppression (NMS) используется для устранения дубликатов с порогом IoU (например, 0.5).
    - **Обрезанные штрих-коды**: Входные изображения подаются в полном размере (например, 960x1280), без предварительной обрезки. Модель обучается распознавать частично видимые коды благодаря аугментации (обрезка, повороты, шум).
    

### Метрики для обучения

- **Loss-функция**:
    - Используется стандартная loss-функция YOLO11x-OBB: комбинация **Generalized IoU (GIoU)** для локализации и **Cross-Entropy** для классификации.
    - GIoU штрафует предсказания, которые не полностью покрывают ground truth, что частично решает задачу полного охвата кодов.
- **Аугментация**:
    - Применяются повороты, масштабирование, добавление шума и частичная обрезка, чтобы модель училась распознавать обрезанные и перекрывающиеся коды.



### Оценка качества модели

Стандартный IoU недостаточен, так как не гарантирует полного покрытия штрих-кодов для дальнейшего декодирования. Предлагается использовать следующие кастомные метрики:

1. **Coverage Ratio (CR)**:

    ![Formula](https://latex.codecogs.com/svg.latex?CR%20=%20\frac{\text{Area%20of%20Intersection}}{\text{Area%20of%20Ground%20Truth}})
        
    - Цель: Убедиться, что предсказанный четырёхугольник покрывает ≥95% истинного (CR ≥ 0.95).
    - Реализация: С помощью shapely для вычисления площади пересечения и ground truth.
2. **Hausdorff Distance (HD)**:
    - Измеряет максимальное расстояние между вершинами предсказанного и истинного четырёхугольников.
    - Цель: HD ≤ 10 пикселей для точной формы и ориентации.
    - Реализация: Через scipy.spatial.distance.directed_hausdorff.
3. **Decoding Success Rate (DSR)**:

     ![DSR Formula](https://latex.codecogs.com/svg.latex?DSR%20=%20\frac{\text{Number%20of%20Successfully%20Decoded%20Codes}}{\text{Total%20Number%20of%20Codes}})
     
    - Цель: Максимально высокий DSR (например, >90%), проверяется с помощью декодера (например, pyzbar).
- **Процесс оценки**:
    - После инференса извлекаются предсказания (results.obb.xyxyxyxy), вычисляются CR и HD для каждого объекта.
    - Области обрезаются и передаются в декодер для подсчёта DSR.
    - Метрики усредняются по валидационной выборке.

### Выходные данные модели

- **Формат предсказаний**:
    - Для каждого объекта:
        - Координаты вершин: [x1, y1, x2, y2, x3, y3, x4, y4].
        - Класс: Например, "ean13" (class_id=0).
        - Уверенность: Значение от 0 до 1.

---

### Обработка перекрытия и обрезанных штрих-кодов

1. **Перекрытие штрих-кодов**:
    - **Детекция**: YOLO11x-OBB использует NMS для фильтрации перекрывающихся предсказаний. Порог IoU для NMS (например, 0.5) настраивается так, чтобы сохранить оба кода, если они различимы.
    - **Решение**: Если перекрытие слишком сильное, модель может объединить коды в одно предсказание. Для улучшения разделения можно увеличить разрешение входного изображения (например, imgsz=1280) или дообучить модель на примерах с перекрытием.
2. **Обрезанные штрих-коды**:
    - **Детекция**: Модель обучается на аугментированных данных с обрезанными кодами, чтобы предсказывать их даже при частичной видимости.
    - **Обработка**: Предсказанные четырёхугольники могут выходить за границы изображения. В таких случаях область обрезается до видимой части, и декодер пытается обработать доступные данные. Если код не декодируется, это отражается в DSR.

---

### Процесс детекции и передачи в декодирование

1. **Подготовка данных**:
    - Изображения и аннотации преобразуются в формат YOLO OBB. Разделение на train/val/test (например, 70/20/10).
2. **Обучение**:
    - Оптимизация по GIoU и cross entropy loss.
3. **Инференс**:
    - Выполняется на тестовом датасете
    - Выход: Координаты вершин, классы, уверенность.
4. **Оценка качества**:
    - Вычисление CR, HD и DSR на валидационной выборке.
5. **Подготовка для декодирования**:
    - Обрезка изображения по предсказанным вершинам с помощью OpenCV:

---

# Пайплайн классификации грубо нормализованных зон штрих-кодов и QR-кодов с YOLO11x-OBB

## Цель
Использовать YOLO11x-OBB для классификации типов штрих-кодов и QR-кодов (например, "qr", "ean13", "dm") на основе грубо нормализованных зон, полученных в процессе детекции. Пайплайн учитывает перекрытие штрих-кодов и исключает обрезанные коды, чтобы обеспечить точную классификацию перед декодированием.

---

## Используемая модель
- **Модель**: **YOLO11x-OBB** 
- **Функциональность**:
  - Выполняет одновременную детекцию (координаты четырёхугольников) и классификацию (тип кода) в одном проходе.
  - Выдаёт классы ("qr", "ean13", "dm") с вероятностями для каждой обнаруженной зоны.
- **Почему выбрана**:
  - Нативная поддержка классификации oriented объектов.
  - Высокая точность (mAP@50 ~81.3% на DOTAv1).
  - Эффективность благодаря единому пайплайну детекции и классификации.
- **Предобучение**: Веса с DOTAv1, дообучение на пользовательском датасете.

---

## Данные и формат подачи
- **Формат входных данных для классификации**:
  - YOLO11x-OBB работает с полными изображениями (например, 960x1280), содержащими штрих-коды и QR-коды.
  - Грубо нормализованные зоны не подаются в модель отдельно — классификация происходит непосредственно на основе признаков, извлечённых из областей, определённых предсказанными четырёхугольниками внутри исходного изображения.
- **Подача в модель**:
  - Вход: Исходные изображения в формате `[H, W, 3]` (RGB).
  - Аннотации для обучения: Нормализованные координаты вершин и class_id в формате YOLO OBB (например, `0 0.286 0.132 0.271 0.127 0.293 0.120 0.305 0.125`).
  - Файл `data.yaml`: `names: ['qr', 'ean13', 'dm']`.
- **Обработка особых случаев**:
  - **Перекрытие штрих-кодов**: Обрабатывается через Non-Maximum Suppression (NMS) внутри YOLO11x-OBB, классификация выполняется для каждого разделённого объекта.
  - **Обрезанные штрих-коды**: Не подаются отдельно в классификацию, так как фильтрация происходит на этапе пост-обработки предсказаний (см. ниже).

---

## Метрики для обучения
- **Loss-функция**:
  - **Cross-Entropy Loss**: Применяется к классификационной части модели.
    - может быть изменена на Focal Loss или иные модификации Cross-Entropy, если будет дисбаланс классов или важно штрафовать модель за неправильный прогноз.
  - Полная потеря включает также GIoU для локализации, но для классификации фокус на Cross-Entropy.
- **Оптимизатор**: Adam, learning rate = 0.001 (с возможным lr-scheduler).
- **Аугментация**:
  - Повороты, масштабирование, изменения яркости/контраста.
  - Без сильной обрезки, чтобы модель училась классифицировать только полностью видимые коды.

---

## Оценка качества модели (классификации)
- **Метрики**:
  1. **Classification Accuracy**:
     - Доля правильно классифицированных зон по сравнению с ground truth.
     - Цель: >95%.
  2. **Precision, Recall, F1-Score**:
     - Оценка по классам.
     - Цель: F1 > 0.9 для каждого класса.
  3. **Confusion Matrix**:
     - Анализ ошибок классификации.
- **Процесс оценки**:
  - Извлечение предсказанных классов (`result.obb.cls`) и сравнение с истинными метками.
  - Фильтрация обрезанных кодов перед оценкой (CR < 0.9 или вершины у края).
  - Вычисление метрик на валидационной выборке.
- **Дополнительно**: Проверка согласованности классификации с последующим декодированием.

---

## Обработка перекрытия и обрезанных штрих-кодов
- **Перекрытие штрих-кодов**:
  - **Обработка в YOLO11x-OBB**: NMS (порог IoU = 0.5) разделяет перекрывающиеся коды. Каждый код классифицируется независимо на основе извлечённых признаков.
  - **Улучшение**: Настройка порога NMS или дообучение на примерах перекрытий для лучшего разделения.
  - **Выход**: Отдельные классы для каждой зоны (например, "ean13" и "qr").
- **Обрезанные штрих-коды**:
  - **Фильтрация**: 
    - На этапе пост-обработки: Исключение предсказаний, где вершины ближе 10 пикселей к краю или CR < 0.9 (при наличии ground truth).
    - Классификация таких зон не оценивается и не используется.
  - **Результат**: Обрезанные коды (например, треть штрих-кода) не влияют на классификацию, так как отбрасываются после предсказания.

---

## Пайплайн классификации грубо нормализованных зон
1. **Входные данные**:
   - Полное изображение подаётся в YOLO11x-OBB.
2. **Детекция и классификация**:
   - YOLO11x-OBB предсказывает:
     - Координаты вершин: `[x1, y1, x2, y2, x3, y3, x4, y4]`.
     - Класс
     - Уверенность: 0-1.
   - Классификация происходит на основе признаков из областей четырёхугольников внутри модели.
3. **Фильтрация**:
   - Исключение обрезанных кодов:
     - Проверка границ (отступ 10 пикселей).
     - (Опционально) CR < 0.9.
4. **Оценка классификации**:
   - Сравнение предсказанных классов с ground truth.
   - Вычисление Accuracy, Precision, Recall, F1.
5. **Выход**:
   - Классы отфильтрованных зон для дальнейшего декодирования.

---

## Итоговый пайплайн
1. **Вход**: Полное изображение с штрих-кодами и QR-кодами.
2. **Классификация**: YOLO11x-OBB определяет тип кода внутри предсказанных зон.
3. **Фильтрация**: Исключение обрезанных кодов (границы, CR < 0.9).
4. **Оценка**: Accuracy > 95%, F1 > 0.9 по классам.
5. **Выход**: Классы полностью видимых зон.
