# Detector Pipeline

### TL:DR 
### Итоговый пайплайн

1. **Вход**: Изображение  с штрих-кодами и QR-кодами.
2. **Детекция**: YOLO11x-OBB предсказывает четырёхугольники, классы и уверенность.
3. **Оценка**: Проверка CR (≥0.95), HD (≤10 пикселей), DSR (>90%).
4. **Обработка**: Обрезка по вершинам.
5. **Выход**: Обрезанные изображения подаются в декодер.

---
### Используемая модель

- **Модель**: **YOLO11x-OBB** .
- **Почему выбрана**:
    - Поддерживает oriented object detection с предсказанием произвольных четырёхугольников, что соответствует разметке данных.
    - Наиболее современная модель на данный момент (октябрь 2024)
    - Удобное обучение и настройка модели (работает практически из коробки)
    - Высокая точность (mAP@50 около 81.3% на DOTAv1) и современная архитектура
    - Гибкость для работы с несколькими типами кодов (QR, EAN13, DM) на одном изображении.
- **Предобучение**: Используются веса, предобученные на датасете DOTAv1, с последующей дообучкой на нашем датасете.


### Данные и формат подачи

- **Формат разметки**:
    - Аннотации представлены в виде json файлов содержащих произвольные четырёхугольники (quadrilaterals) с координатами четырёх вершин (x1, y1, x2, y2, x3, y3, x4, y4) и тегами классов (например, "ean13", "qr", "dm").
- **Подача в модель**:
    - Данные преобразуются в формат YOLO OBB: текстовые файлы с нормализованными координатами вершин и идентификатором класса (например, 0 0.286 0.132 0.271 0.127 0.293 0.120 0.305 0.125).
    - Файл data.yaml определяет пути к изображениям и классы
- **Обработка особых случаев**:
    - **Перекрытие штрих-кодов**: YOLO11x-OBB поддерживает детекцию нескольких объектов в одном изображении, включая перекрывающиеся. Non-Maximum Suppression (NMS) используется для устранения дубликатов с порогом IoU (например, 0.5).
    - **Обрезанные штрих-коды**: Входные изображения подаются в полном размере (например, 960x1280), без предварительной обрезки. Модель обучается распознавать частично видимые коды благодаря аугментации (обрезка, повороты, шум).
    

### Метрики для обучения

- **Loss-функция**:
    - Используется стандартная loss-функция YOLO11x-OBB: комбинация **Generalized IoU (GIoU)** для локализации и **Cross-Entropy** для классификации.
    - GIoU штрафует предсказания, которые не полностью покрывают ground truth, что частично решает задачу полного охвата кодов.
- **Аугментация**:
    - Применяются повороты, масштабирование, добавление шума и частичная обрезка, чтобы модель училась распознавать обрезанные и перекрывающиеся коды.



### Оценка качества модели

Стандартный IoU недостаточен, так как не гарантирует полного покрытия штрих-кодов для дальнейшего декодирования. Предлагается использовать следующие кастомные метрики:

1. **Coverage Ratio (CR)**:

    ![Formula](https://latex.codecogs.com/svg.latex?CR%20=%20\frac{\text{Area%20of%20Intersection}}{\text{Area%20of%20Ground%20Truth}})
        
    - Цель: Убедиться, что предсказанный четырёхугольник покрывает ≥95% истинного (CR ≥ 0.95).
    - Реализация: С помощью shapely для вычисления площади пересечения и ground truth.
2. **Hausdorff Distance (HD)**:
    - Измеряет максимальное расстояние между вершинами предсказанного и истинного четырёхугольников.
    - Цель: HD ≤ 10 пикселей для точной формы и ориентации.
    - Реализация: Через scipy.spatial.distance.directed_hausdorff.
3. **Decoding Success Rate (DSR)**:

     ![DSR Formula](https://latex.codecogs.com/svg.latex?DSR%20=%20\frac{\text{Number%20of%20Successfully%20Decoded%20Codes}}{\text{Total%20Number%20of%20Codes}})
     
    - Цель: Максимально высокий DSR (например, >90%), проверяется с помощью декодера (например, pyzbar).
- **Процесс оценки**:
    - После инференса извлекаются предсказания (results.obb.xyxyxyxy), вычисляются CR и HD для каждого объекта.
    - Области обрезаются и передаются в декодер для подсчёта DSR.
    - Метрики усредняются по валидационной выборке.

### Выходные данные модели

- **Формат предсказаний**:
    - Для каждого объекта:
        - Координаты вершин: [x1, y1, x2, y2, x3, y3, x4, y4].
        - Класс: Например, "ean13" (class_id=0).
        - Уверенность: Значение от 0 до 1.

---

### Обработка перекрытия и обрезанных штрих-кодов

1. **Перекрытие штрих-кодов**:
    - **Детекция**: YOLO11x-OBB использует NMS для фильтрации перекрывающихся предсказаний. Порог IoU для NMS (например, 0.5) настраивается так, чтобы сохранить оба кода, если они различимы.
    - **Решение**: Если перекрытие слишком сильное, модель может объединить коды в одно предсказание. Для улучшения разделения можно увеличить разрешение входного изображения (например, imgsz=1280) или дообучить модель на примерах с перекрытием.
2. **Обрезанные штрих-коды**:
    - **Детекция**: Модель обучается на аугментированных данных с обрезанными кодами, чтобы предсказывать их даже при частичной видимости.
    - **Обработка**: Предсказанные четырёхугольники могут выходить за границы изображения. В таких случаях область обрезается до видимой части, и декодер пытается обработать доступные данные. Если код не декодируется, это отражается в DSR.

---

### Процесс детекции и передачи в декодирование

1. **Подготовка данных**:
    - Изображения и аннотации преобразуются в формат YOLO OBB. Разделение на train/val/test (например, 70/20/10).
2. **Обучение**:
    - Оптимизация по GIoU и cross entropy loss.
3. **Инференс**:
    - Выполняется на тестовом датасете
    - Выход: Координаты вершин, классы, уверенность.
4. **Оценка качества**:
    - Вычисление CR, HD и DSR на валидационной выборке.
5. **Подготовка для декодирования**:
    - Обрезка изображения по предсказанным вершинам с помощью OpenCV:



